<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Quiz</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #0b0f1a;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app {
      min-height: 100vh;
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topbar { display: flex; gap: 10px; }

    .pill {
      flex: 1;
      text-align: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 800;
      font-size: 13px;
    }

    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 16px;
    }

    .question {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .hint {
      margin: 8px 0 0;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      line-height: 1.4;
    }

    .timerWrap {
      margin-top: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .timerBar {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.55);
      transform-origin: left center;
      transform: scaleX(1);
    }

    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .choiceBtn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
    }

    .choiceBtn:disabled { opacity: 0.95; cursor: default; }

    .correct { border-color: #22c55e !important; }
    .wrong   { border-color: #ef4444 !important; }

    .restart {
      width: 100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #fff;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      padding: 10px 0 6px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="pill" id="roundPill">Round 1 / 5</div>
      <div class="pill" id="scorePill">Score: 0</div>
    </div>

    <div class="card">
      <p class="question" id="questionText">Loading…</p>
      <p class="hint" id="hintText">Tap an answer.</p>

      <div class="timerWrap" aria-label="Timer">
        <div class="timerBar" id="timerBar"></div>
      </div>

      <div class="choices" id="choicesArea"></div>

      <button class="restart" id="restartBtn" style="display:none;">Restart (New Set)</button>
    </div>

    <div class="footer">5 rounds • 3s timer • mixed operations • anti ones-digit cheat</div>
  </div>

<script>
  // =========================
  // SETTINGS YOU CAN EDIT
  // =========================
  const TIME_LIMIT_MS = 3000;
  const FEEDBACK_MS   = 650;
  const TICK_MS       = 40;

  // Anti-cheat: how many of the 4 choices should share the correct one's digit (including the correct answer).
  // Set to 2 or 3. (3 is harder)
  const MIN_SAME_ONES_DIGIT_CHOICES = 3;

  // Question mix (total should be 5)
  const ADD_COUNT = 3;
  const MUL_COUNT = 2;

  // You asked for subtraction too (3-digit - 2-digit).
  // If you want to include subtraction, set SUB_COUNT > 0 and reduce MUL_COUNT or ADD_COUNT so total stays 5.
  const SUB_COUNT = 0; // <-- change to 2 (and set MUL_COUNT to 0) if you want 3 add + 2 sub.

  // Ranges
  const ADD_A_MIN = 20,  ADD_A_MAX = 199;
  const ADD_B_MIN = 20,  ADD_B_MAX = 199;

  // Subtraction: 3-digit - 2-digit, keep result non-negative
  const SUB_A_MIN = 100, SUB_A_MAX = 999;
  const SUB_B_MIN = 10,  SUB_B_MAX = 99;

  // Multiplication: two-digit times one-digit (keeps answers mostly 2–3 digits)
  const MUL_A_MIN = 12,  MUL_A_MAX = 99;
  const MUL_B_MIN = 2,   MUL_B_MAX = 9;

  // =========================
  // STATE
  // =========================
  let quiz = [];
  let idx = 0;
  let score = 0;

  let roundStart = 0;
  let timerInterval = null;
  let timeoutHandle = null;
  let locked = false;

  // =========================
  // ELEMENTS
  // =========================
  const roundPill = document.getElementById("roundPill");
  const scorePill = document.getElementById("scorePill");
  const questionText = document.getElementById("questionText");
  const hintText = document.getElementById("hintText");
  const choicesArea = document.getElementById("choicesArea");
  const restartBtn = document.getElementById("restartBtn");
  const timerBar = document.getElementById("timerBar");

  // =========================
  // UTIL
  // =========================
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffleInPlace(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function clearTimers() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    if (timeoutHandle) { clearTimeout(timeoutHandle); timeoutHandle = null; }
  }

  function disableAllChoices() {
    choicesArea.querySelectorAll("button").forEach(b => b.disabled = true);
  }

  function highlightCorrect(correctVal) {
    choicesArea.querySelectorAll("button").forEach(b => {
      if (Number(b.textContent) === correctVal) b.classList.add("correct");
    });
  }

  // =========================
  // DISTRACTORS (ANTI ONES-DIGIT CHEAT)
  // =========================
  function buildDistractors(correct) {
    const targetOnes = ((correct % 10) + 10) % 10;
    const needSame = Math.max(0, MIN_SAME_ONES_DIGIT_CHOICES - 1); // how many wrong answers should share ones digit

    const chosen = new Set();

    // Step 1: force some distractors that share the same ones digit (add/subtract multiples of 10)
    const tensSteps = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
    while ([...chosen].filter(v => ((v % 10) + 10) % 10 === targetOnes).length < needSame) {
      const step = tensSteps[randInt(0, tensSteps.length - 1)];
      const sign = Math.random() < 0.5 ? -1 : 1;
      let cand = correct + sign * step;
      if (cand < 0) cand = correct + step;
      if (cand !== correct) chosen.add(cand);
      if (chosen.size > 40) break; // safety
    }

    // Step 2: fill remaining distractors with small “near miss” offsets (changes ones digit)
    const nearOffsets = [-1, +1, -2, +2, -3, +3, -4, +4, -5, +5, -8, +8, -9, +9, -11, +11, -12, +12, -15, +15];
    while (chosen.size < 3) {
      const off = nearOffsets[randInt(0, nearOffsets.length - 1)];
      let cand = correct + off;
      if (cand < 0) cand = correct + Math.abs(off);
      if (cand !== correct) chosen.add(cand);
      if (chosen.size > 80) break;
    }

    let distractors = Array.from(chosen).slice(0, 3);

    // Step 3: final guarantee (rare edge cases)
    const totalSame = [correct, ...distractors].filter(v => ((v % 10) + 10) % 10 === targetOnes).length;
    if (totalSame < MIN_SAME_ONES_DIGIT_CHOICES) {
      // adjust one distractor by +/-10 until ones digit matches
      for (let i = 0; i < distractors.length; i++) {
        let v = distractors[i];
        while (((v % 10) + 10) % 10 !== targetOnes) v += 10;
        if (v !== correct && !distractors.includes(v)) {
          distractors[i] = v;
          break;
        }
      }
    }

    return distractors;
  }

  // =========================
  // QUESTION GENERATORS
  // =========================
  function makeAddition(usedKeys) {
    let a, b, key;
    do {
      a = randInt(ADD_A_MIN, ADD_A_MAX);
      b = randInt(ADD_B_MIN, ADD_B_MAX);
      const min = Math.min(a, b), max = Math.max(a, b);
      key = `A:${min}+${max}`;
    } while (usedKeys.has(key));
    usedKeys.add(key);

    const correct = a + b;
    const choices = shuffleInPlace([correct, ...buildDistractors(correct)]);
    return { q: `${a} + ${b} = ?`, correct, choices };
  }

  function makeSubtraction(usedKeys) {
    let a, b, key;
    do {
      a = randInt(SUB_A_MIN, SUB_A_MAX); // 3-digit
      b = randInt(SUB_B_MIN, SUB_B_MAX); // 2-digit
      if (b > a) [a, b] = [b + 100, a % 100]; // keep it safe; still ends up 3-digit minus 2-digit-ish
      key = `S:${a}-${b}`;
    } while (usedKeys.has(key));
    usedKeys.add(key);

    const correct = a - b;
    const choices = shuffleInPlace([correct, ...buildDistractors(correct)]);
    return { q: `${a} − ${b} = ?`, correct, choices };
  }

  function makeMultiplication(usedKeys) {
    let a, b, key;
    do {
      a = randInt(MUL_A_MIN, MUL_A_MAX); // 2-digit
      b = randInt(MUL_B_MIN, MUL_B_MAX); // 1-digit
      key = `M:${a}×${b}`;
    } while (usedKeys.has(key));
    usedKeys.add(key);

    const correct = a * b;
    const choices = shuffleInPlace([correct, ...buildDistractors(correct)]);
    return { q: `${a} × ${b} = ?`, correct, choices };
  }

  function buildNewQuiz() {
    const total = ADD_COUNT + MUL_COUNT + SUB_COUNT;
    if (total !== 5) {
      // Keep it simple: enforce 5 rounds without breaking the game
      console.warn("ADD_COUNT + MUL_COUNT + SUB_COUNT must equal 5. Using default 3 add + 2 mul.");
    }

    const usedKeys = new Set();
    const q = [];

    for (let i = 0; i < ADD_COUNT; i++) q.push(makeAddition(usedKeys));
    for (let i = 0; i < MUL_COUNT; i++) q.push(makeMultiplication(usedKeys));
    for (let i = 0; i < SUB_COUNT; i++) q.push(makeSubtraction(usedKeys));

    // If misconfigured, fallback to 3 add + 2 mul
    while (q.length < 5) q.push(makeAddition(usedKeys));
    if (q.length > 5) q.length = 5;

    // Shuffle order + reshuffle choice positions
    shuffleInPlace(q);
    q.forEach(item => shuffleInPlace(item.choices));
    return q;
  }

  // =========================
  // TIMER
  // =========================
  function startTimer() {
    clearTimers();
    locked = false;

    roundStart = performance.now();
    timerBar.style.transform = "scaleX(1)";

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - roundStart;
      const remaining = Math.max(0, TIME_LIMIT_MS - elapsed);
      timerBar.style.transform = `scaleX(${remaining / TIME_LIMIT_MS})`;
      if (remaining <= 0) timerBar.style.transform = "scaleX(0)";
    }, TICK_MS);

    timeoutHandle = setTimeout(() => {
      if (locked) return;
      locked = true;

      disableAllChoices();
      const item = quiz[idx];
      hintText.textContent = `Time’s up ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);

      clearTimers();
      setTimeout(nextRound, FEEDBACK_MS);
    }, TIME_LIMIT_MS);
  }

  // =========================
  // GAME RENDER / FLOW
  // =========================
  function setPills() {
    roundPill.textContent = `Round ${Math.min(idx + 1, quiz.length)} / ${quiz.length}`;
    scorePill.textContent = `Score: ${score}`;
  }

  function renderQuestion() {
    setPills();
    restartBtn.style.display = "none";

    const item = quiz[idx];
    questionText.textContent = item.q;
    hintText.textContent = "Tap an answer (3 seconds).";

    choicesArea.innerHTML = "";
    item.choices.forEach((value) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.textContent = value;
      btn.addEventListener("click", () => handleAnswer(btn, value));
      choicesArea.appendChild(btn);
    });

    startTimer();
  }

  function handleAnswer(clickedBtn, value) {
    if (locked) return;
    locked = true;

    clearTimers();
    disableAllChoices();

    const item = quiz[idx];
    const isCorrect = value === item.correct;

    if (isCorrect) {
      score += 1;
      clickedBtn.classList.add("correct");
      hintText.textContent = "Correct ✅";
    } else {
      clickedBtn.classList.add("wrong");
      hintText.textContent = `Wrong ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);
    }

    scorePill.textContent = `Score: ${score}`;
    timerBar.style.transform = "scaleX(0)";

    setTimeout(nextRound, FEEDBACK_MS);
  }

  function nextRound() {
    idx += 1;
    if (idx >= quiz.length) renderResult();
    else renderQuestion();
  }

  function renderResult() {
    clearTimers();
    locked = true;

    const total = quiz.length;
    const pct = Math.round((score / total) * 100);

    roundPill.textContent = "Finished";
    scorePill.textContent = `Score: ${score}`;

    questionText.textContent = `${pct}% (${score}/${total})`;
    hintText.textContent = "Restart to play again with a new set.";

    choicesArea.innerHTML = "";
    timerBar.style.transform = "scaleX(0)";

    restartBtn.style.display = "block";
  }

  function startNewRun() {
    clearTimers();
    quiz = buildNewQuiz();
    idx = 0;
    score = 0;
    locked = false;
    renderQuestion();
  }

  restartBtn.addEventListener("click", startNewRun);

  // Start
  startNewRun();
</script>
</body>
</html>
