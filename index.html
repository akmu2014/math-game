<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5-Round Math Quiz</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #0b0f1a;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app {
      min-height: 100vh;
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topbar { display: flex; gap: 10px; }

    .pill {
      flex: 1;
      text-align: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 800;
      font-size: 13px;
    }

    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 16px;
    }

    .question {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .hint {
      margin: 8px 0 0;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      line-height: 1.4;
    }

    .timerWrap {
      margin-top: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .timerBar {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.55);
      transform-origin: left center;
      transform: scaleX(1);
    }

    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .choiceBtn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
    }

    .choiceBtn:disabled { opacity: 0.95; cursor: default; }

    .correct { border-color: #22c55e !important; }
    .wrong   { border-color: #ef4444 !important; }

    .restart {
      width: 100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #fff;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      padding: 10px 0 6px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="pill" id="roundPill">Round 1 / 5</div>
      <div class="pill" id="scorePill">Score: 0</div>
    </div>

    <div class="card">
      <p class="question" id="questionText">Loading…</p>
      <p class="hint" id="hintText">Tap an answer.</p>

      <div class="timerWrap" aria-label="Timer">
        <div class="timerBar" id="timerBar"></div>
      </div>

      <div class="choices" id="choicesArea"></div>

      <button class="restart" id="restartBtn" style="display:none;">Restart (New Questions)</button>
    </div>

    <div class="footer">5 rounds • 3s timer • anti-ones-digit-cheat choices</div>
  </div>

<script>
  // ---------- SETTINGS ----------
  const NUM_ROUNDS    = 5;
  const TIME_LIMIT_MS = 3000;
  const FEEDBACK_MS   = 650;
  const TICK_MS       = 40;

  // 2–3 digit addends
  const A_MIN = 20,  A_MAX = 199;
  const B_MIN = 20,  B_MAX = 199;

  // We want at least this many choices (including the correct one)
  // to share the same ones digit as the correct answer.
  // Example: if correct ends with 2, then at least 2 or 3 options end with 2.
  const MIN_SAME_ONES_DIGIT_CHOICES = 3; // set to 2 or 3

  // ---------- STATE ----------
  let quiz = [];
  let idx = 0;
  let score = 0;

  let roundStart = 0;
  let timerInterval = null;
  let timeoutHandle = null;
  let locked = false;

  // ---------- ELEMENTS ----------
  const roundPill = document.getElementById("roundPill");
  const scorePill = document.getElementById("scorePill");
  const questionText = document.getElementById("questionText");
  const hintText = document.getElementById("hintText");
  const choicesArea = document.getElementById("choicesArea");
  const restartBtn = document.getElementById("restartBtn");
  const timerBar = document.getElementById("timerBar");

  // ---------- UTIL ----------
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffleInPlace(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function clearTimers() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    if (timeoutHandle) { clearTimeout(timeoutHandle); timeoutHandle = null; }
  }

  function disableAllChoices() {
    choicesArea.querySelectorAll("button").forEach(b => b.disabled = true);
  }

  function highlightCorrect(correctVal) {
    choicesArea.querySelectorAll("button").forEach(b => {
      if (Number(b.textContent) === correctVal) b.classList.add("correct");
    });
  }

  // ---------- DISTRACTOR GENERATION (ANTI-ONES-DIGIT CHEAT) ----------
  function sameOnesDigitCandidates(correct) {
    // Offsets that KEEP the ones digit the same: +/-10, +/-20, +/-30, etc.
    // Also some larger but still plausible steps.
    return [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
  }

  function differentOnesDigitCandidates(correct) {
    // Small offsets that change ones digit, for variety
    return [-1, +1, -2, +2, -3, +3, -5, +5, -8, +8, -9, +9, -11, +11, -12, +12, -15, +15];
  }

  function buildDistractors(correct) {
    const targetOnes = ((correct % 10) + 10) % 10;

    // We want (MIN_SAME_ONES_DIGIT_CHOICES - 1) distractors that share the same ones digit
    const needSame = Math.max(0, MIN_SAME_ONES_DIGIT_CHOICES - 1);

    const chosen = new Set();

    // 1) Pick distractors that keep ones digit the same (offsets multiple of 10)
    const sameSteps = sameOnesDigitCandidates(correct);
    while ([...chosen].filter(v => v % 10 === targetOnes).length < needSame) {
      const step = sameSteps[randInt(0, sameSteps.length - 1)];
      const sign = Math.random() < 0.5 ? -1 : 1;
      let cand = correct + sign * step;

      if (cand < 0) cand = correct + step; // keep positive
      if (cand !== correct) chosen.add(cand);

      // safety to avoid infinite loops (should never happen)
      if (chosen.size > 30) break;
    }

    // 2) Fill remaining distractors (until we have 3 total wrong answers)
    const diffSteps = differentOnesDigitCandidates(correct);
    while (chosen.size < 3) {
      const off = diffSteps[randInt(0, diffSteps.length - 1)];
      let cand = correct + off;
      if (cand < 0) cand = correct + Math.abs(off);

      // Avoid duplicating correct and existing choices
      if (cand !== correct) chosen.add(cand);

      if (chosen.size > 50) break;
    }

    // 3) Final check: ensure at least the minimum same-ones-digit count is met across all 4 choices
    // (correct + distractors)
    const distractors = Array.from(chosen).slice(0, 3);

    const totalSame = [correct, ...distractors].filter(v => (v % 10 + 10) % 10 === targetOnes).length;

    // If not enough (rare), force-adjust one distractor to match ones digit by adding/subtracting 10
    if (totalSame < MIN_SAME_ONES_DIGIT_CHOICES) {
      for (let i = 0; i < distractors.length && totalSame < MIN_SAME_ONES_DIGIT_CHOICES; i++) {
        let v = distractors[i];
        // make v have same ones digit as correct
        const delta = (targetOnes - ((v % 10 + 10) % 10) + 10) % 10; // 0..9
        // easiest: add delta (changes ones digit) then add 10 to keep it "close-ish"
        // But we want ones digit to match exactly; we can adjust by adding/subtracting delta, then add 10 if needed.
        let adjusted = v + delta;
        // If adjusted accidentally equals correct or duplicates, shift by +/-10
        if (adjusted === correct || distractors.includes(adjusted)) adjusted += 10;
        if (adjusted < 0) adjusted += 20;

        distractors[i] = adjusted;
      }
    }

    return distractors;
  }

  // ---------- QUESTION GENERATION ----------
  function makeOneQuestion(usedPairs) {
    let a, b, key;
    do {
      a = randInt(A_MIN, A_MAX);
      b = randInt(B_MIN, B_MAX);
      const min = Math.min(a, b), max = Math.max(a, b);
      key = `${min}+${max}`;
    } while (usedPairs.has(key));

    usedPairs.add(key);

    const correct = a + b;
    const wrongs = buildDistractors(correct);
    const choices = shuffleInPlace([correct, ...wrongs]);

    return {
      q: `${a} + ${b} = ?`,
      correct,
      choices
    };
  }

  function buildNewQuiz() {
    const usedPairs = new Set();
    const q = [];
    while (q.length < NUM_ROUNDS) q.push(makeOneQuestion(usedPairs));

    // Shuffle question order and reshuffle choices for safety
    shuffleInPlace(q);
    q.forEach(item => shuffleInPlace(item.choices));
    return q;
  }

  // ---------- TIMER ----------
  function startTimer() {
    clearTimers();
    locked = false;

    roundStart = performance.now();
    timerBar.style.transform = "scaleX(1)";

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - roundStart;
      const remaining = Math.max(0, TIME_LIMIT_MS - elapsed);
      const ratio = remaining / TIME_LIMIT_MS;
      timerBar.style.transform = `scaleX(${ratio})`;
      if (remaining <= 0) timerBar.style.transform = "scaleX(0)";
    }, TICK_MS);

    timeoutHandle = setTimeout(() => {
      if (locked) return;
      locked = true;

      disableAllChoices();
      const item = quiz[idx];
      hintText.textContent = `Time’s up ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);

      clearTimers();
      setTimeout(nextRound, FEEDBACK_MS);
    }, TIME_LIMIT_MS);
  }

  // ---------- RENDER / GAMEPLAY ----------
  function setPills() {
    roundPill.textContent = `Round ${Math.min(idx + 1, quiz.length)} / ${quiz.length}`;
    scorePill.textContent = `Score: ${score}`;
  }

  function renderQuestion() {
    setPills();
    restartBtn.style.display = "none";

    const item = quiz[idx];
    questionText.textContent = item.q;
    hintText.textContent = "Tap an answer (3 seconds).";

    choicesArea.innerHTML = "";
    item.choices.forEach((value) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.textContent = value;
      btn.addEventListener("click", () => handleAnswer(btn, value));
      choicesArea.appendChild(btn);
    });

    startTimer();
  }

  function handleAnswer(clickedBtn, value) {
    if (locked) return;
    locked = true;

    clearTimers();
    disableAllChoices();

    const item = quiz[idx];
    const isCorrect = value === item.correct;

    if (isCorrect) {
      score += 1;
      clickedBtn.classList.add("correct");
      hintText.textContent = "Correct ✅";
    } else {
      clickedBtn.classList.add("wrong");
      hintText.textContent = `Wrong ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);
    }

    scorePill.textContent = `Score: ${score}`;
    timerBar.style.transform = "scaleX(0)";

    setTimeout(nextRound, FEEDBACK_MS);
  }

  function nextRound() {
    idx += 1;
    if (idx >= quiz.length) renderResult();
    else renderQuestion();
  }

  function renderResult() {
    clearTimers();
    locked = true;

    const total = quiz.length;
    const pct = Math.round((score / total) * 100);

    roundPill.textContent = "Finished";
    scorePill.textContent = `Score: ${score}`;

    questionText.textContent = `${pct}% (${score}/${total})`;
    hintText.textContent = "Restart to play again with new questions.";

    choicesArea.innerHTML = "";
    timerBar.style.transform = "scaleX(0)";

    restartBtn.style.display = "block";
  }

  // ---------- START / RESTART ----------
  function startNewRun() {
    clearTimers();
    quiz = buildNewQuiz();   // ✅ NEW randomized questions + anti-ones-digit cheat choices
    idx = 0;
    score = 0;
    locked = false;
    renderQuestion();
  }

  restartBtn.addEventListener("click", startNewRun);

  // First run
  startNewRun();
</script>
</body>
</html>
