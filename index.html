<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5-Round Math Quiz</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #0b0f1a;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app {
      min-height: 100vh;
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topbar { display: flex; gap: 10px; }

    .pill {
      flex: 1;
      text-align: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 800;
      font-size: 13px;
    }

    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 16px;
    }

    .question {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .hint {
      margin: 8px 0 0;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      line-height: 1.4;
    }

    /* Timer bar */
    .timerWrap {
      margin-top: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .timerBar {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.55);
      transform-origin: left center;
      transform: scaleX(1);
    }

    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .choiceBtn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
    }

    .choiceBtn:disabled { opacity: 0.95; cursor: default; }

    .correct { border-color: #22c55e !important; }
    .wrong   { border-color: #ef4444 !important; }

    .restart {
      width: 100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #fff;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      padding: 10px 0 6px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="pill" id="roundPill">Round 1 / 5</div>
      <div class="pill" id="scorePill">Score: 0</div>
    </div>

    <div class="card">
      <p class="question" id="questionText">Loading…</p>
      <p class="hint" id="hintText">Tap an answer.</p>

      <div class="timerWrap" aria-label="Timer">
        <div class="timerBar" id="timerBar"></div>
      </div>

      <div class="choices" id="choicesArea"></div>

      <button class="restart" id="restartBtn" style="display:none;">Restart (New Questions)</button>
    </div>

    <div class="footer">Mobile math quiz • 5 rounds • 3s timer • new questions each run</div>
  </div>

<script>
  // ---------- SETTINGS ----------
  const NUM_ROUNDS    = 5;
  const TIME_LIMIT_MS = 3000; // 3 seconds
  const FEEDBACK_MS   = 650;  // show red/green briefly
  const TICK_MS       = 40;   // timer bar smoothness

  // Difficulty tuning: two- or three-digit addends
  const A_MIN = 20,  A_MAX = 199; // 2–3 digits
  const B_MIN = 20,  B_MAX = 199;

  // ---------- STATE ----------
  let quiz = [];   // generated each run: [{ q, correct, choices }]
  let idx = 0;
  let score = 0;

  // timer state
  let roundStart = 0;
  let timerInterval = null;
  let timeoutHandle = null;
  let locked = false;

  // ---------- ELEMENTS ----------
  const roundPill = document.getElementById("roundPill");
  const scorePill = document.getElementById("scorePill");
  const questionText = document.getElementById("questionText");
  const hintText = document.getElementById("hintText");
  const choicesArea = document.getElementById("choicesArea");
  const restartBtn = document.getElementById("restartBtn");
  const timerBar = document.getElementById("timerBar");

  // ---------- UTIL ----------
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffleInPlace(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function clearTimers() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    if (timeoutHandle) { clearTimeout(timeoutHandle); timeoutHandle = null; }
  }

  function disableAllChoices() {
    choicesArea.querySelectorAll("button").forEach(b => b.disabled = true);
  }

  function highlightCorrect(correctVal) {
    choicesArea.querySelectorAll("button").forEach(b => {
      if (Number(b.textContent) === correctVal) b.classList.add("correct");
    });
  }

  // ---------- QUESTION GENERATION ----------
  function generateDistractors(correct) {
    // Close, plausible wrong answers (not too obvious)
    // Mix of near misses and common arithmetic slips.
    const offsets = [
      -1, +1, -2, +2, -3, +3, -5, +5, -8, +8, -9, +9, -10, +10,
      -11, +11, -12, +12, -15, +15, -18, +18
    ];

    const pool = new Set();
    while (pool.size < 3) {
      const off = offsets[randInt(0, offsets.length - 1)];
      let candidate = correct + off;

      // keep it reasonable & positive
      if (candidate < 0) candidate = correct + Math.abs(off);

      // ensure not equal to correct
      if (candidate !== correct) pool.add(candidate);
    }

    return Array.from(pool);
  }

  function makeOneQuestion(usedPairs) {
    // Ensure we don't repeat the same addends in a single run
    let a, b, key;
    do {
      a = randInt(A_MIN, A_MAX);
      b = randInt(B_MIN, B_MAX);
      // normalize pair so (a,b) same as (b,a)
      const min = Math.min(a, b), max = Math.max(a, b);
      key = `${min}+${max}`;
    } while (usedPairs.has(key));

    usedPairs.add(key);

    const correct = a + b;

    // Build choices: 1 correct + 3 plausible wrongs
    const wrongs = generateDistractors(correct);
    const choices = shuffleInPlace([correct, ...wrongs]);

    return {
      q: `${a} + ${b} = ?`,
      correct,
      choices
    };
  }

  function buildNewQuiz() {
    const usedPairs = new Set();
    const q = [];
    while (q.length < NUM_ROUNDS) {
      q.push(makeOneQuestion(usedPairs));
    }
    // Optional: shuffle question order too
    shuffleInPlace(q);
    // Choices already shuffled inside each question, but you can reshuffle again:
    q.forEach(item => shuffleInPlace(item.choices));
    return q;
  }

  // ---------- TIMER ----------
  function startTimer() {
    clearTimers();
    locked = false;

    roundStart = performance.now();
    timerBar.style.transform = "scaleX(1)";

    timerInterval = setInterval(() => {
      const elapsed = performance.now() - roundStart;
      const remaining = Math.max(0, TIME_LIMIT_MS - elapsed);
      const ratio = remaining / TIME_LIMIT_MS;
      timerBar.style.transform = `scaleX(${ratio})`;
      if (remaining <= 0) timerBar.style.transform = "scaleX(0)";
    }, TICK_MS);

    timeoutHandle = setTimeout(() => {
      if (locked) return;
      locked = true;

      disableAllChoices();
      const item = quiz[idx];
      hintText.textContent = `Time’s up ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);

      clearTimers();
      setTimeout(nextRound, FEEDBACK_MS);
    }, TIME_LIMIT_MS);
  }

  // ---------- RENDER / GAMEPLAY ----------
  function setPills() {
    roundPill.textContent = `Round ${Math.min(idx + 1, quiz.length)} / ${quiz.length}`;
    scorePill.textContent = `Score: ${score}`;
  }

  function renderQuestion() {
    setPills();
    restartBtn.style.display = "none";

    const item = quiz[idx];
    questionText.textContent = item.q;
    hintText.textContent = "Tap an answer (3 seconds).";

    choicesArea.innerHTML = "";
    item.choices.forEach((value) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.textContent = value;
      btn.addEventListener("click", () => handleAnswer(btn, value));
      choicesArea.appendChild(btn);
    });

    startTimer();
  }

  function handleAnswer(clickedBtn, value) {
    if (locked) return;
    locked = true;

    clearTimers();
    disableAllChoices();

    const item = quiz[idx];
    const isCorrect = value === item.correct;

    if (isCorrect) {
      score += 1;
      clickedBtn.classList.add("correct");
      hintText.textContent = "Correct ✅";
    } else {
      clickedBtn.classList.add("wrong");
      hintText.textContent = `Wrong ❌ (Answer: ${item.correct})`;
      highlightCorrect(item.correct);
    }

    scorePill.textContent = `Score: ${score}`;
    timerBar.style.transform = "scaleX(0)";

    setTimeout(nextRound, FEEDBACK_MS);
  }

  function nextRound() {
    idx += 1;
    if (idx >= quiz.length) renderResult();
    else renderQuestion();
  }

  function renderResult() {
    clearTimers();
    locked = true;

    const total = quiz.length;
    const pct = Math.round((score / total) * 100);

    roundPill.textContent = "Finished";
    scorePill.textContent = `Score: ${score}`;

    questionText.textContent = `${pct}% (${score}/${total})`;
    hintText.textContent = "Restart to play again with new questions.";

    choicesArea.innerHTML = "";
    timerBar.style.transform = "scaleX(0)";

    restartBtn.style.display = "block";
  }

  // ---------- START / RESTART ----------
  function startNewRun() {
    clearTimers();
    quiz = buildNewQuiz();   // ✅ NEW randomized questions + choices each run
    idx = 0;
    score = 0;
    locked = false;
    renderQuestion();
  }

  restartBtn.addEventListener("click", startNewRun);

  // First run
  startNewRun();
</script>
</body>
</html>
